<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no,viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telphone=no, email=no" />
    <meta name="msapplication-tap-highlight" content="no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>设置红包金额</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />

    <script src="http://small.ying-ji.com/moqi/answer/js/jquery-1.11.3.min.js"></script>
    <script src='//res.wx.qq.com/open/js/jweixin-1.2.0.js'></script>
    <script type="text/javascript" src="http://small.ying-ji.com/moqi/answer/js/prompt.min.js"></script>
    <script type="text/javascript" src="http://small.ying-ji.com/moqi/answer/js/prompt.js"></script>
    <!-- <link href='http://cdn.webfont.youziku.com/webfonts/nomal/119220/46604/5c1da18cf629d90124dd5332.css' rel='stylesheet' type='text/css' /> -->
    <link href='http://small.ying-ji.com/moqi/answer/css/pay.css' rel='stylesheet' type='text/css' />
    <!-- 	<link href='http://small.ying-ji.com/moqi/answer/css/prompt.css' rel='stylesheet' type='text/css' />
 -->
    <link rel="stylesheet" type="text/css" href="./static/answer/css/common.css" />
    <link rel="stylesheet" type="text/css" href="./static/answer/css/style.css" />
    <script src="./static/answer/js/common.js" type="text/javascript" charset="utf-8"></script>

    <style>
        html {
            font-size: 50px;
        }

        .Prompt_floatBoxBg {
            display: none;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            position: fixed !important;
            /*ie7 ff*/
            position: absolute;
            top: 0;
            left: 0;
            filter: alpha(opacity=0);
            opacity: 0;
            z-index: 999;
        }

        .Prompt_floatBox {
            z-index: 1000;
            display: block;
            position: absolute;
            text-align: center;
            top: 49%;
            left: 0;
            right: 0;
            height: auto;
            z-index: 10000;
            opacity: 1;
        }

        .Prompt_floatBox .content {
            word-wrap: break-word;
            -webkit-box-shadow: rgba(0, 0, 0, 0.498039) 0px 0px 15px;
            box-shadow: rgba(0, 0, 0, 0.498039) 0px 0px 15px;
            font-size: 0.4rem;
            line-height: 1.1rem;
            margin: 0 auto;
            border-radius: 0.1rem;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .text {
            position: relative;
        }

        .content .form .text .rit {
            position: absolute;
            top: 0;
            left: 0;
            width: 5.5rem;
            height: 100%;
        }

        .content .form .text input {
            width: 90%;
            height: 100%;
        }
    </style>

</head>

<body style="height:13rem;background-color:#ffdb2c;">
    <div class="page" style="padding:0rem 0.25rem;height:12rem;">
        <div class="container">
            <div class="content">
                <div class="logo">
                    <img style="border-radius:1.5em;"
                        src="http://thirdwx.qlogo.cn/mmopen/vi_32/fSTBicGrG1sgX0R8vfOTtOeiboCS7nBlyAZ84zNIpIGCZL72eZMLpp9g8YwDYfzI5bzW7zJfynL7cVdYrpibIyjNQ/132">
                </div>

                <div class="form">
                    <div class="text">
                        <p>奖金总额</p>
                        <p class="rit">
                            <input type="number" name="money" maxlength="5" onkeyup="num(this)" placeholder="填写金额" />元
                        </p>
                    </div>
                    <div class="text">
                        <p>奖励个数</p>
                        <p class="rit">
                            <input type="number" name="bonus_num" maxlength="5" onkeyup="describeC(this)"
                                placeholder="填写数量" />个
                        </p>
                    </div>
                    <div class="text">
                        <p>答对几题可领取</p>
                        <p class="rit">
                            <input type="number" name="right_num" maxlength="2" onkeyup="describeR(this)"
                                placeholder="填写题数" />题
                        </p>
                    </div>

                </div>
                <div class="price">支付<span>￥0.00</span></div>
                <div class="tips">含平台 1%的服务费</div>
                <div class="btn">
                    <a href="#">塞钱进红包</a>
                </div>
                <div class="warning">注：未领完的红包将在24小时后退回账户余额</div>
            </div>
        </div>
    </div>
    <div style="display:none">
        <script src="https://s23.cnzz.com/z_stat.php?id=1276099993&web_id=1276099993" language="JavaScript"></script>
    </div>
</body>

<script type="application/javascript">
    var bonus_total = 0;
    //个数验证
    function describeC(obj) {
        //console.log("foucessss:");
        //$("#tips2").hide();
        var count = $("input[name='bonus_num']").val();
        if ("" == count) {
            return false;
        }
        if (count < 1) {
            $("input[name='bonus_num']").val("");
            $.Prompt("<font>红包个数必须大于1哦~</font>");
            return false;
        }
        var money = $("input[name='money']").val();
        if ("" == money) {
            //$("input[name='money']").val("");
            $.Prompt("请输入红包金额");
            $("input[name='money']").focus();
            return false;
        }

        bonus_total = Number(money) * 1.01;
        bonus_total = bonus_total.toFixed(2);
        var avg_money = Number(money) / Number(count);
        avg_money = avg_money.toFixed(2);
        if (avg_money * 100 < 1) {
            $("input[name='bonus_num']").val("");
            $.Prompt("红包人均金额必须大于0.01哦~");

            return false;
        }

        /*             var describe = "目前红包人均"+avg_money+"元，一共"+count+"个";
                    $(".item_tips .title").html(describe);
         */
        $(".price").html("支付<span>￥" + bonus_total + "</span>");
    }

    //只能输入两个小数
    function num(obj) {

        var money = $("input[name='money']").val();
        if ("" == money) {
            return false;
        }

        var count = $("input[name='bonus_num']").val();
        if ("" == count) {
            return false;
        }

        bonus_total = Number(money) * 1.01;
        bonus_total = bonus_total.toFixed(2);
        var avg_money = Number(money) / Number(count);
        avg_money = avg_money.toFixed(2);
        //if(avg_money<1){
        //$("input[name='money']").val("");
        //$.Prompt("红包人均金额必须大于1哦~");
        //return false;
        //}		
        /*             var describe = "目前红包人均"+avg_money+"元，一共"+count+"个";
        			$(".item_tips .title").html(describe);
         */
        $(".price").html("支付<span>￥" + bonus_total + "</span>");

    }

    //答对题目次数验证
    function describeR() {
        var right_num = $("input[name='right_num']").val();
        if (right_num > 10 || right_num < 1) {
            $("input[name='right_num']").val("");
            $.Prompt("答对范围在1-10哦~");
            return false;
        }
    }

    $(function () {
        wxpay();
    })

    $(".btn").click(function () {
        //遮挡层展示
        num(this);
        var money = $("input[name='money']").val();
        if ("" == money) {
            $.Prompt("红包金额必须大于1哦~");
            return false;
        }
        var count = $("input[name='bonus_num']").val();
        if ("" == count) {
            $.Prompt("红包个数不能为空哦~");
            return false;
        }
        var right_num = $("input[name='right_num']").val();
        if ("" == right_num) {
            $.Prompt("答对范围在1-10哦~");
            return false;
        }
        var avg_money = Number(money) / Number(count);
        avg_money = avg_money.toFixed(2);
        if (avg_money * 100 < 1) {
            $("input[name='money']").val("");
            $("input[name='bonus_num']").val("");
            $.Prompt("红包人均金额必须大于0.01哦~");
            return false;
        }

        $('.btn').html('<a href="#">正在提交</a>');
        jsApiCall();
    });

    function wxpay() {

        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: "wx3c2aebe5fd63bb54", // 必填，公众号的唯一标识
            timestamp: "1578796588", // 必填，生成签名的时间戳
            nonceStr: "khfg3ek1lmps7isn", // 必填，生成签名的随机串
            signature: "5347d51649fddfd53f4596dfb6d290fc8f267705", // 必填，签名，见附录1
            jsApiList: ['chooseWXPay'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });
    }

    //调用微信JS api 支付
    function jsApiCall() {
        var money = $("input[name='money']").val();
        var bonus_num = $("input[name='bonus_num']").val();
        var right_num = $("input[name='right_num']").val();
        var sex_limit = $("#receive").val();

        bonus_num = Number(bonus_num);
        right_num = Number(right_num);
        var bonus_total_pay = Number(bonus_total);
        var sid = "11429976";
        var utm = "www.renrentb.com";
        console.log("bonus_total:" + bonus_total);
        console.log("sid:" + sid);
        //数据验证
        if ('' == right_num || 0 >= right_num || '' == bonus_num || 0 >= bonus_num || '' == bonus_total_pay || 0 >= bonus_total_pay) {
            console.log("right_num:" + right_num);
            console.log("bonus_num:" + bonus_num);
            console.log("bonus_total:" + bonus_total);
            console.log("空空空空空空空空空空");
            return false;
        }

        console.log("sex_limit:" + sex_limit);
        var wxpaypost;
        $.ajax({
            type: "post",
            data: {
                sid: sid,
                channel_id: 12,
                money: money,
                bonus_num: bonus_num,
                right_num: right_num,
                sex_limit: sex_limit,
                utm: utm
            },
            url: "/index.php/index/answer/setbonus.html",
            dataType: "json",
            async: true,
            cache: true,
            success: function (data) {
                console.log("------------------");
                console.log(data);
                console.log("------------------");
                var data = JSON.parse(data);
                console.log(data);
                console.log("------------------");
                if (data.code == 200) {

                    wx.chooseWXPay({
                        timestamp: data.options.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                        nonceStr: data.options.nonceStr, // 支付签名随机串，不长于 32 位
                        package: data.options.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                        signType: data.options.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                        paySign: data.options.paySign, // 支付签名
                        success: function (res) {


                            window.location.href = "http://www.renrentb.com/index/answer/paySuccess?sid=MDAwMDAwMDAwMH21epaxo56Wg7K8ow";

                            //window.location.href = "/index.php/index/answer/code.html";
                        },
                        cancel: function (res) {
                            $("#paystatus").val(0);

                        }
                    });
                    $('.btn').html('<a href="#">塞钱进红包</a>');
                } else {
                    if (data.code == 220) {
                        $('.btn').html('<a href="#">塞钱进红包</a>');
                        alert("付款成功，马上分享吧！");
                        location.reload(true);

                        //                                window.location.href = "http://www.renrentb.com/index/answer/paySuccess?sid=MDAwMDAwMDAwMH21epaxo56Wg7K8ow";

                    } else {
                        alert(data.msg);

                    }
                }

            }
        });

    }
</script>

</html>